# Using this Repo

## Autogenerated CAN interface Library

The ```.dbc``` file that use used to define the CAN communication network for the vehicle resides in the ```dbc``` folder. This repository will automatically generate the .c and .h files needed for packing and unpacking CAN bus Messages. There are some guidelines on how you should edit the ```.dbc``` file so as not to upset the rest of the team. 

At every push to the github server, a Github Action will fire, checking if any files in the ```dbc``` directory have changed. If they have, it will run and overwrite the output in the ```can_conv``` directory. It will then commit the changes.

The underlying code used for the conversion can be seen [here](https://github.com/howerj/dbcc#dbc-convertercompiler). Please note the restriction on 8 byte. I think the 8-bites noted on the first paragraph is supposed to be bytes.

There is a limitation on this. Only a single can ```.dbc``` file can be used across a single executable. So if you have more than one CAN bus network, all messages need to reside in a single file. Other libraries don't do that but they are slower. 

**DANGER**: So as not to ruin other people's work, it's very important that you not rename the ```.dbc``` file and only add signals and messages to it. Modifying existing signal names and changing existing message structures may cause breaking changes that you'll need to fix later.


## Arduino, VSCode and Some Silly Restrictions:
Arduino abstracts a lot of SW development pain away from us but it has some silly things going on such as a forced directory structure.
It keeps things simplified for software noobs so I suggest to stick with it. Other embedded programming frameworks are complicated.
Amoung other things, here's what it always wants to see:
- Parent directory and Sketch file name match. 
- In the parent directory, another directory ```src``` exists that contains code that is part of the sketch but not an official or installed library.
<br>

Because the parent directory and sketch file have the aformenetioned name requirements, you can't compile multiple sketches using the same ```src``` directory. That means we have to have the CAN interface files described above available in the ```src``` directory. Instead of making copies over and over again, we leverage symbolic links which are just a fancy shortcut pointing to another location. This is why you need to have Developer Mode on. It's a newer feature. Additionally, specify the cmd or powershell terminal for vscode and git usage so as to not break the symlinks. 

It gets better with some more idiocy with the VSCode Arduino plugin. When opening a folder, VScode will create the ```.vscode``` directory for certain settings. An ```arduino.json``` will be created defining some settings for the board type and including the sketch files. So if you're using VSCode for compilation and serial monitor, just open the folder with the ```.ino``` file.


# Setup
 Enable Developer Mode on Windows 10.
    - [Instructions here.](https://docs.microsoft.com/en-us/windows/apps/get-started/enable-your-device-for-development)
- Install git for Windows. During installation make sure to Enable Symbolic Links.  
    - [Download page here.](https://git-scm.com/download/win) Get the 64 bit installer. 
- Install the Arduino IDE. Don't get the fancy new one. Get the standard 1.8.x
    - [Download page here.](https://www.arduino.cc/en/software)
- Install the board packages for the Feather M4 CAN.
    - [Instructions and address provided here.](https://learn.adafruit.com/adafruit-feather-m4-can-express/arduino-ide-setup) Should be self explanatory.
    - You should not need a special driver for this. Should just plug in and be visible after selecting a COM Port. 
    - Verify you can connect to the board and see output on the Serial Monitor in the Arduino IDE.
- Install the CAN library for the Feather M4 CAN. It is titled ```CAN Adafruit Fork```.
    - [Instructions on adding libraries provided here.](https://docs.arduino.cc/software/ide-v1/tutorials/installing-libraries)
- Optional: Install VSCode with reccomended packages:
    - ```vsciot-vscode.vscode-arduino```
    - ```ms-vscode.cpptools```
    - ```eamodio.gitlens```
- In order to contribute code you will need to set up a github account and and SSH Key to authenticate for pushing to the repository.
    - [Here](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent) and [here](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account#adding-a-new-ssh-key-to-your-account) describe how you generate and integrate the SSH Key.
    - I also suggestion following the suggestions [here](https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-personal-account-on-github/managing-email-preferences/setting-your-commit-email-address) for using the provided github noreply email address for your ```user.email```. I'm weird so I even just use my github account name for ```user.name```. 
- Clone this repository. Again use cmd or powershell. Not git bash or WSL.

Newbies, reach out of this is not complete enough. This is all very straightforward to me but may be daunting to those with less time in the trenches. 

# How to Use This Repo for a New Node: 

1. Leave the CAN_Node_Example as-is. That's a template. Review it carefully and get a feel for what it's doing. As the team asks me questions on how to execute something, I would be making my updates and changes there. 
2. When you're ready to create a new node, make a copy of that directory to the root of the repo. This will copy the required symbolic link as well.
3. Due to the sensitivity of the symbolic links in windows, make sure you're using git from cmd or powershell (i.e. Not git bash or WSL).
4. Do not touch the ```can_conv``` directory. You'll break the symbolic links. 
5. When editing the .dbc file, only use CANDb++ editor and only add signals and messages.
     - Code is generated based on signal and message names along with the message ID values. Changing these will break code referencing that generated code. 
     - It is okay to re-arrange existing signals or add signals with a message. 
     - Do not move signals to another message unless the team has buy-in and you are ready to change code to accomodate the move. 