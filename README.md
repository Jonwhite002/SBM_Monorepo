# SBM Monorepo

This was created to ease development of a compatible vehicle network for the team and get some members learning and understanding CAN and some basic software development techniques. The team's origins are grounded in Mechanical Engineering but the highest paid engineers in automotive do a lot of software now regardless of what their degree says.

My hope here is to help the team understand how this all works as well as grease the skids with some glue code, templates and cloud automation to allow you guys to focus on the actual domain content and getting data.

[Here are some notes on some important concepts.](docs/crash_course.md)

## Autogenerated CAN interface Library

The ```.dbc``` file that use used to define the CAN communication network for the vehicle resides in the ```dbc``` folder. This repository will automatically generate the .c and .h files needed for packing and unpacking CAN bus Messages. 

At every push to the github server, a Github Action will fire, checking if any files in the ```dbc``` directory have changed. If they have, it will run and overwrite the output in the ```can_conv``` directory. It will then commit the changes.

The underlying code used for the conversion can be seen [here](https://github.com/howerj/dbcc#dbc-convertercompiler). Please note the restriction on 8 byte. I think the 8-bites noted on the first paragraph is supposed to be bytes. 

**DANGER**: So as not to ruin other people's work, it's very important that you not rename the ```.dbc``` file and only add signals and messages to it. Modifying existing signal names and changing existing message structures may cause breaking changes that you'll need to fix later.


## Arduino, VSCode and Some Silly Restrictions:
Arduino abstracts a lot of SW development pain away from us but it has some silly things going on such as a forced directory structure.
It keeps things simplified for software noobs so I suggest to stick with it. Other embedded programming frameworks are complicated.
Amoung other things, here's what it always wants to see:
- Parent directory and Sketch file name match. 
- In the parent directory, another directory ```src``` exists that contains code that is part of the sketch but not an official or installed library.
<br>

Because the parent directory and sketch file have the aformenetioned name requirements, you can't compile multiple sketches using the same ```src``` directory. That means we have to have the CAN interface files described above available in the ```src``` directory. Instead of making copies over and over again, we leverage symbolic links which are just a fancy shortcut pointing to another location. This is why you need to have Developer Mode on. It's a newer feature. Additionally, specify the cmd or powershell terminal for vscode and git usage so as to not break the symlinks. 


It gets better with some more idiocy with the VSCode Arduino plugin. When opening a folder, VScode will create the ```.vscode``` directory for certain settings. An ```arduino.json``` will be created defining some settings for the board type and including the sketch files. So if you're using VSCode for compilation and serial monitor, just open the folder with the ```.ino``` file.


# Setup
``` TODO: ADD LINKS```
- Enable Developer Mode on Windows 10.
- Install git for Windows. During installation make sure to Enable Symbolic Links.  
- Install the Arduino Client. Don't get the fancy new one. 
- Install the board packages for the Feather M4 CAN.
    - You should not need a special driver for this. Should just plug in.
    - Verify you can connect to the board and see output on the Serial Monitor.
- Install the CAN library for the Feather M4 CAN. It is titled ```CAN Adafruit Fork```.
- Optional: Install VSCode with reccomended packages:
    - ```vsciot-vscode.vscode-arduino```
    - ```ms-vscode.cpptools```
    - ```eamodio.gitlens```
- Clone this repository. Again use cmd or powershell. Not git bash or WSL

Newbies, reach out of this is not complete enough. 

# How to Use This Repo for a New Node: 

1. Leave the CAN_Node_Example as-is. That's a template. Review it carefully and get a feel for what it's doing. As the team asks me questions on how to execute something, I would be making my updates and changes there. 
2. When you're ready to create a new node, make a copy of that directory to the root of the repo. This will copy the required symbolic link as well.
3. Due to the sensitivity of the symbolic links in windows, make sure you're using git from cmd or powershell (i.e. Not git bash or WSL).

# Future Work 

Since the .dbc is stored here, data conversion tools should be alongside it to reference it.

